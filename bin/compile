#!/usr/bin/env bash
# bin/compile <BUILD_DIR> <CACHE_DIR> <ENV_DIR>

# Abort on errors!
set -e

# Output helpers
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
source $BIN_DIR/utils

# given variables
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# add the XeLaTeX to the future PATH + update actual PATH
echo ":$BUILD_DIR/buildpack/bin/x86_64-linux" >> $ENV_DIR/PATH
echo ":$BUILD_DIR/buildpack/bin/x86_64-linux" >> $ENV_DIR/BIN_PATH
export PATH="$PATH:$BUILD_DIR/buildpack/bin/x86_64-linux"
# set path to the archive
TEXLIVE_ARCHIVE_PATH="$BIN_DIR/../static_latex.tar.xz"
VERSION=$(stat --format "%y" $TEXLIVE_ARCHIVE_PATH)
build-step "Using XeLaTeX archive from: $VERSION"
tar xf $TEXLIVE_ARCHIVE_PATH -C $BUILD_DIR

# Check for an essential binary to make sure it's installed
if [ ! `which xelatex` ]; then
    build-warn "XeLaTeX Live installation failed"
    exit 1
fi

# run testing build
build-step "Now - running the testing build\n\n\n"

cd $BUILD_DIR/buildpack/bin/x86_64-linux/
mktexlsr  # reindex the packages
xelatex --shell-escape -synctex=1 -interaction=nonstopmode ./brano2017-02-09_buildpack.tex
